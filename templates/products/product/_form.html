{% load humanize %}
<!-- Product Form - Ultra Compact Layout -->
<form 
    hx-post="{% if product %}{% url 'product:edit' product.pk %}{% else %}{% url 'product:create' %}{% endif %}"
    hx-encoding="multipart/form-data"
    x-data="{ loading: false, imagePreviews: [] }"
    @submit="loading = true"
    class="space-y-3">
    {% csrf_token %}
    
    <!-- Error Messages -->
    <div id="form-errors" class="hidden">
        <div class="bg-red-50 border border-red-200 text-red-800 px-3 py-2 rounded-lg text-xs">
            <i class="fas fa-exclamation-circle mr-1"></i>
            <span id="error-message"></span>
        </div>
    </div>

    <div class="grid grid-cols-12 gap-4">
        <!-- LEFT COLUMN: Main Info (Cols 8) -->
        <div class="col-span-12 md:col-span-8 space-y-3">
            
            <!-- Brand & Category -->
            {% if product %}
            <!-- Edit mode: Show brand & category info (read-only) -->
            <div class="bg-blue-50 border border-blue-200 px-3 py-2 rounded-lg flex justify-between items-center">
                <div class="text-xs text-blue-800">
                    <i class="fas fa-building mr-1"></i>
                    <strong>Brand:</strong> {{ product.brand.name }} ({{ product.brand.company.name }})
                </div>
                <div class="text-xs text-blue-800">
                    <i class="fas fa-list mr-1"></i>
                    <strong>Category:</strong> {{ product.category.name }}
                </div>
                <input type="hidden" name="brand_id" value="{{ product.brand.id }}">
            </div>
            {% else %}
            <!-- Create mode: Brand from global filter -->
            {% if current_brand %}
            <div class="bg-green-50 border border-green-200 px-3 py-2 rounded-lg">
                <div class="text-xs text-green-800">
                    <i class="fas fa-tag mr-1"></i>
                    <strong>Brand:</strong> {{ current_brand.name }} ({{ current_brand.company.name }})
                </div>
                <input type="hidden" name="brand_id" value="{{ current_brand.id }}">
            </div>
            {% else %}
            <div class="bg-yellow-50 border border-yellow-200 px-3 py-2 rounded-lg">
                <div class="flex items-start">
                    <i class="fas fa-exclamation-triangle text-yellow-500 mt-0.5 mr-2 text-sm"></i>
                    <p class="text-xs text-yellow-800">
                        <strong>Brand Required:</strong> Please select a Brand from the header dropdown first.
                    </p>
                </div>
            </div>
            {% endif %}
            
            <!-- Category -->
            <div>
                <label for="category_id" class="block text-xs font-medium text-gray-700 mb-1">
                    Category <span class="text-red-500">*</span>
                </label>
                <select 
                    name="category_id" 
                    id="category_id"
                    required
                    class="w-full px-3 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Select Category</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <!-- Category (Only for Edit mode if needed to change category, but usually locked. Assuming logic from before) -->
            {% if product %}
            <!-- Hidden category input or separate change logic if needed, but based on previous code it was just info box in edit mode? No, wait. 
                 Previous code had info box AND category select. Let's keep Category Select available even in Edit Mode if user wants to change it. 
                 Actually, the previous code showed info box BUT also had the select below it. 
                 Let's put Category Select here if it's Edit Mode too, to allow changing. -->
            <div>
                <label for="category_id" class="block text-xs font-medium text-gray-700 mb-1">
                    Category <span class="text-red-500">*</span>
                </label>
                <select 
                    name="category_id" 
                    id="category_id"
                    required
                    class="w-full px-3 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Select Category</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if product and product.category_id == category.id %}selected{% endif %}>
                        {{ category.brand.name }} - {{ category.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            <!-- SKU & Name Row -->
            <div class="grid grid-cols-12 gap-3">
                <div class="col-span-4">
                    <label for="sku" class="block text-xs font-medium text-gray-700 mb-1">
                        SKU <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        name="sku" 
                        id="sku"
                        value="{{ product.sku|default:'' }}"
                        required
                        maxlength="50"
                        placeholder="e.g., F001"
                        class="w-full px-3 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        {% if product %}readonly{% endif %}>
                </div>
                <div class="col-span-8">
                    <label for="name" class="block text-xs font-medium text-gray-700 mb-1">
                        Product Name <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        name="name" 
                        id="name"
                        value="{{ product.name|default:'' }}"
                        required
                        maxlength="200"
                        placeholder="e.g., Nasi Goreng Spesial"
                        class="w-full px-3 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
            
            <!-- Description -->
            <div>
                <label for="description" class="block text-xs font-medium text-gray-700 mb-1">
                    Description <small class="text-gray-500">(Optional)</small>
                </label>
                <textarea 
                    name="description" 
                    id="description"
                    rows="2"
                    maxlength="500"
                    placeholder="Product description..."
                    class="w-full px-3 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">{{ product.description|default:'' }}</textarea>
            </div>
            
            <!-- Price & Cost Row -->
            <div class="grid grid-cols-2 gap-3">
                <!-- Price -->
                <div x-data="{ 
                    formatNumber(e) {
                        let val = e.target.value.replace(/[^0-9]/g, '');
                        if (val) e.target.value = new Intl.NumberFormat('en-US').format(val);
                    }
                }">
                    <label for="price" class="block text-xs font-medium text-gray-700 mb-1">
                        Price <span class="text-red-500">*</span>
                    </label>
                    <div class="relative rounded-md shadow-sm">
                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                            <span class="text-gray-500 text-xs">Rp</span>
                        </div>
                        <input 
                            type="text" 
                            name="price" 
                            id="price"
                            value="{{ product.price|default:0|floatformat:0|intcomma }}"
                            required
                            x-init="$el.value = new Intl.NumberFormat('en-US').format($el.value.replace(/[^0-9]/g, ''))"
                            @input="formatNumber"
                            placeholder="0"
                            class="block w-full rounded-md border-gray-300 pl-8 focus:border-blue-500 focus:ring-blue-500 text-xs py-1.5 border text-right">
                    </div>
                </div>
                
                <!-- Cost -->
                <div x-data="{ 
                    formatNumber(e) {
                        let val = e.target.value.replace(/[^0-9]/g, '');
                        if (val) e.target.value = new Intl.NumberFormat('en-US').format(val);
                    }
                }">
                    <label for="cost" class="block text-xs font-medium text-gray-700 mb-1">
                        Cost <small class="text-gray-500">(Margin Calc)</small>
                    </label>
                    <div class="relative rounded-md shadow-sm">
                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                            <span class="text-gray-500 text-xs">Rp</span>
                        </div>
                        <input 
                            type="text" 
                            name="cost" 
                            id="cost"
                            value="{{ product.cost|default:0|floatformat:0|intcomma }}"
                            x-init="$el.value = new Intl.NumberFormat('en-US').format($el.value.replace(/[^0-9]/g, ''))"
                            @input="formatNumber"
                            placeholder="0"
                            class="block w-full rounded-md border-gray-300 pl-8 focus:border-blue-500 focus:ring-blue-500 text-xs py-1.5 border text-right">
                    </div>
                </div>
            </div>

            <!-- Stock Tracking (Horizontal) -->
            <div class="border rounded-lg p-2 bg-gray-50 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <input 
                        type="checkbox" 
                        name="track_stock" 
                        id="track_stock"
                        {% if product.track_stock %}checked{% endif %}
                        class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="track_stock" class="text-xs font-medium text-gray-700">
                        Track Stock
                    </label>
                </div>
                
                <div x-show="document.getElementById('track_stock')?.checked" class="flex items-center space-x-2">
                    <label for="stock_quantity" class="text-xs font-medium text-gray-700">
                        Qty:
                    </label>
                    <input 
                        type="number" 
                        name="stock_quantity" 
                        id="stock_quantity"
                        value="{{ product.stock_quantity|default:'0' }}"
                        min="0"
                        step="0.01"
                        class="w-24 px-2 py-1 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-right">
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Status & Images (Cols 4) -->
        <div class="col-span-12 md:col-span-4 space-y-3">
            
            <!-- Status Card -->
            <div class="bg-gray-50 p-3 rounded-lg border space-y-3">
                <div class="flex items-center justify-between border-b pb-2">
                    <label for="is_active" class="text-xs font-bold text-gray-700">Active Status</label>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="is_active" id="is_active" {% if not product or product.is_active %}checked{% endif %} class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 checked:right-0 checked:border-blue-600"/>
                        <label for="is_active" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                    <style>
                        .toggle-checkbox:checked { right: 0; border-color: #2563eb; }
                        .toggle-checkbox:checked + .toggle-label { background-color: #2563eb; }
                    </style>
                </div>

                <div>
                    <label for="printer_target" class="block text-xs font-medium text-gray-700 mb-1">Printer</label>
                    <select name="printer_target" id="printer_target" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded-lg">
                        <option value="kitchen" {% if not product or product.printer_target == 'kitchen' %}selected{% endif %}>Kitchen</option>
                        <option value="bar" {% if product.printer_target == 'bar' %}selected{% endif %}>Bar</option>
                        <option value="dessert" {% if product.printer_target == 'dessert' %}selected{% endif %}>Dessert</option>
                    </select>
                </div>

                <div>
                    <label for="sort_order" class="block text-xs font-medium text-gray-700 mb-1">Sort Order</label>
                    <input type="number" name="sort_order" id="sort_order" value="{{ product.sort_order|default:'0' }}" min="0" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded-lg">
                </div>
            </div>

            <!-- Images Card -->
            <div class="border rounded-lg p-3">
                <h4 class="text-xs font-semibold text-gray-900 mb-2 border-b pb-1">
                    <i class="fas fa-image mr-1"></i>Images
                </h4>
                
                {% if product.image %}
                <div class="mb-2 text-center">
                     <img src="{{ product.image.url }}" alt="Main" class="h-24 mx-auto object-cover rounded border shadow-sm">
                     <p class="text-[10px] text-gray-500 mt-1">Main Image</p>
                </div>
                {% endif %}

                <div class="mb-2">
                    <label for="images" class="block text-xs font-medium text-gray-700 mb-1">
                        {% if product %}Add More{% else %}Upload{% endif %}
                    </label>
                    <input 
                        type="file" 
                        name="images" 
                        id="images"
                        multiple
                        accept="image/*"
                        @change="
                            imagePreviews = [];
                            for (let file of $event.target.files) {
                                const reader = new FileReader();
                                reader.onload = (e) => imagePreviews.push(e.target.result);
                                reader.readAsDataURL(file);
                            }
                        "
                        class="w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>

                <!-- Previews Grid -->
                <div class="grid grid-cols-3 gap-1">
                    {% if product and product.photos.all %}
                        {% for photo in product.photos.all %}
                        <div class="relative group">
                            <img src="{{ photo.photo.url }}" class="w-full h-12 object-cover rounded border">
                            <button type="button" hx-delete="{% url 'product:photo-delete' photo.pk %}" hx-confirm="Del?" class="absolute top-0 right-0 bg-red-600 text-white w-4 h-4 flex items-center justify-center rounded-bl opacity-0 group-hover:opacity-100 text-[10px]"><i class="fas fa-times"></i></button>
                        </div>
                        {% endfor %}
                    {% endif %}
                    <template x-for="(preview, index) in imagePreviews" :key="index">
                        <div class="relative">
                            <img :src="preview" class="w-full h-12 object-cover rounded border border-blue-400">
                            <span x-show="index === 0" class="absolute top-0 left-0 bg-blue-600 text-white text-[8px] px-1 rounded-br">New</span>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Form Actions -->
    <div class="flex justify-end gap-2 pt-3 border-t">
        <button 
            type="button"
            @click="showModal = false"
            class="px-4 py-1.5 bg-white text-gray-700 text-xs font-medium rounded-lg border border-gray-300 hover:bg-gray-50 transition">
            Cancel
        </button>
        <button 
            type="submit"
            :disabled="loading"
            class="px-4 py-1.5 bg-blue-600 text-white text-xs font-medium rounded-lg hover:bg-blue-700 transition disabled:opacity-50">
            <span x-show="!loading">
                <i class="fas fa-save mr-1"></i>
                {% if product %}Update{% else %}Create{% endif %}
            </span>
            <span x-show="loading">
                <i class="fas fa-spinner fa-spin mr-1"></i>
                Saving...
            </span>
        </button>
    </div>
</form>

<script>
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.target.id === 'modal-content') {
            try {
                const response = JSON.parse(evt.detail.xhr.response);
                if (response.success) {
                    // Close modal and reload table
                    document.querySelector('[x-data]').__x.$data.showModal = false;
                    htmx.trigger('#product-table', 'refresh');
                    
                    // Show toast notification
                    if (typeof showToast !== 'undefined') {
                        showToast(response.message, 'success');
                    }
                } else {
                    // Show error in form
                    document.getElementById('form-errors').classList.remove('hidden');
                    document.getElementById('error-message').textContent = response.message;
                }
            } catch (e) {
                console.error('Error parsing response:', e);
            }
        }
    });
</script>
