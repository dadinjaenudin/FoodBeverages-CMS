<!-- User Form - Ultra Compact (Match Products) -->
<form 
    method="POST" 
    action="{{ request.path }}" 
    class="space-y-3"
    @submit.prevent="
        const form = $el;
        const formData = new FormData(form);
        // Show loading state manually since we use fetch
        form.querySelector('button[type=submit]').disabled = true;
        // Find the loading span and text span
        const btn = form.querySelector('button[type=submit]');
        const textSpan = btn.querySelector('span:first-child');
        const loadSpan = btn.querySelector('span:last-child');
        if(textSpan) textSpan.style.display = 'none';
        if(loadSpan) loadSpan.style.display = 'flex';

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showModal = false;
                // Reload the page to show the toast message
                window.location.reload();
            } else {
                document.getElementById('form-errors').classList.remove('hidden');
                document.getElementById('error-message').textContent = data.message;
                // Reset loading state
                btn.disabled = false;
                if(textSpan) textSpan.style.display = 'flex';
                if(loadSpan) loadSpan.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred');
            btn.disabled = false;
            if(textSpan) textSpan.style.display = 'flex';
            if(loadSpan) loadSpan.style.display = 'none';
        });
    "
    x-data="{ 
        selectedCompany: '{{ user_obj.company_id|default:selected_company_id|default:"" }}',
        selectedBrand: '{{ user_obj.brand_id|default:"" }}',
        selectedStore: '{{ user_obj.store_id|default:"" }}',
        selectedRoleScope: new URLSearchParams(window.location.search).get('scope') || '{{ user_obj.role_scope|default:"store" }}',
        loading: false
    }"
>
    {% csrf_token %}

    <!-- Error Messages -->
    <div id="form-errors" class="hidden">
        <div class="bg-red-50 border border-red-200 text-red-800 px-3 py-2 rounded-lg text-xs">
            <i class="fas fa-exclamation-circle mr-1"></i>
            <span id="error-message"></span>
        </div>
    </div>

    <!-- Personal Information -->
    <div class="grid grid-cols-2 gap-3">
        <!-- Username -->
        <div>
            <label for="username" class="block text-xs font-medium text-gray-700 mb-1">
                Username <span class="text-red-500">*</span>
            </label>
            <input type="text" name="username" id="username" required
                value="{{ user_obj.username }}"
                {% if user_obj %}readonly{% endif %}
                placeholder="johndoe"
                class="w-full px-3 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent {% if user_obj %}bg-gray-100 cursor-not-allowed{% endif %}">
        </div>

        <!-- Email -->
        <div>
            <label for="email" class="block text-xs font-medium text-gray-700 mb-1">Email</label>
            <input type="email" name="email" id="email" 
                value="{{ user_obj.email }}"
                placeholder="john@example.com"
                class="w-full px-3 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>

        <!-- First Name -->
        <div>
            <label for="first_name" class="block text-xs font-medium text-gray-700 mb-1">
                First name <span class="text-red-500">*</span>
            </label>
            <input type="text" name="first_name" id="first_name" 
                value="{{ user_obj.first_name }}"
                placeholder="John"
                class="w-full px-3 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>

        <!-- Last Name -->
        <div>
            <label for="last_name" class="block text-xs font-medium text-gray-700 mb-1">Last name</label>
            <input type="text" name="last_name" id="last_name" 
                value="{{ user_obj.last_name }}"
                placeholder="Doe"
                class="w-full px-3 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
    </div>
    
    <!-- Password -->
    <div>
        <label for="password" class="block text-xs font-medium text-gray-700 mb-1">
            {% if user_obj %}
                Change Password <small class="text-gray-500">(Optional)</small>
            {% else %}
                Password <span class="text-red-500">*</span>
            {% endif %}
        </label>
        <input type="password" name="password" id="password" 
            {% if not user_obj %}required{% endif %}
            placeholder="••••••••"
            class="w-full px-3 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
    </div>

    <!-- Role & Access Control -->
    <div class="grid grid-cols-2 gap-3">
        <!-- Role -->
        <div>
            <label for="role" class="block text-xs font-medium text-gray-700 mb-1">
                System Role <span class="text-red-500">*</span>
            </label>
            <select name="role" id="role" class="w-full px-3 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                {% for code, name in roles %}
                <option value="{{ code }}" {% if user_obj.role == code %}selected{% endif %}>{{ name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Role Scope -->
        <div>
            <label for="role_scope" class="block text-xs font-medium text-gray-700 mb-1">
                Access Scope <span class="text-red-500">*</span>
            </label>
            <select name="role_scope" id="role_scope" x-model="selectedRoleScope" class="w-full px-3 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                {% for code, name in role_scopes %}
                <option value="{{ code }}" {% if user_obj.role_scope == code %}selected{% endif %}>{{ name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="grid grid-cols-3 gap-3"
         x-show="selectedRoleScope != 'global'"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 transform -translate-y-2"
         x-transition:enter-end="opacity-100 transform translate-y-0">
        
        <!-- Company Selection -->
        <div>
            <label for="company_id" class="block text-xs font-medium text-gray-700 mb-1">
                Company <span class="text-red-500">*</span>
            </label>
            <select name="company_id" id="company_id" x-model="selectedCompany"
                :required="selectedRoleScope != 'global'"
                class="w-full px-3 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">Select Company</option>
                {% for company in companies %}
                <option value="{{ company.id }}" {% if user_obj.company_id == company.id %}selected{% endif %}>
                    {{ company.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Brand Selection -->
        <div x-show="selectedCompany && selectedRoleScope != 'company'">
            <label for="brand_id" class="block text-xs font-medium text-gray-700 mb-1">
                Brand <span class="text-red-500" x-show="selectedRoleScope == 'brand' || selectedRoleScope == 'store'">*</span>
            </label>
            <select name="brand_id" id="brand_id" x-model="selectedBrand"
                :required="selectedRoleScope == 'brand' || selectedRoleScope == 'store'"
                class="w-full px-3 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">Select Brand</option>
                {% for brand in brands %}
                <option value="{{ brand.id }}" 
                        data-company="{{ brand.company.id }}"
                        x-show="selectedCompany == '{{ brand.company.id }}'"
                        {% if user_obj.brand_id == brand.id %}selected{% endif %}>
                    {{ brand.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Store Selection -->
        <div x-show="selectedBrand && selectedRoleScope == 'store'">
            <label for="store_id" class="block text-xs font-medium text-gray-700 mb-1">
                Store <span class="text-red-500" x-show="selectedRoleScope == 'store'">*</span>
            </label>
            <select name="store_id" id="store_id" x-model="selectedStore"
                :required="selectedRoleScope == 'store'"
                class="w-full px-3 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">Select Store</option>
                {% for store in stores %}
                <option value="{{ store.id }}" 
                        data-brand="{{ store.brand.id }}"
                        x-show="selectedBrand == '{{ store.brand.id }}'"
                        {% if user_obj.store_id == store.id %}selected{% endif %}>
                    {{ store.store_name }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Active Status -->
    <div class="flex items-center">
        <input 
            type="checkbox" 
            name="is_active" 
            id="is_active"
            {% if not user_obj or user_obj.is_active %}checked{% endif %}
            class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
        <label for="is_active" class="ml-2 text-xs text-gray-700">
            Active user (can log in to the system)
        </label>
    </div>

    <!-- Form Actions -->
    <div class="flex justify-end gap-2 pt-2 border-t border-gray-200">
        <button 
            type="button"
            @click="showModal = false"
            class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
            Cancel
        </button>
        <button 
            type="submit"
            :disabled="loading"
            class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
            <span class="flex items-center">
                <i class="fas fa-save mr-1"></i>
                {% if user_obj %}Update{% else %}Create{% endif %}
            </span>
            <span class="items-center hidden">
                <i class="fas fa-circle-notch fa-spin mr-1"></i>
                Saving...
            </span>
        </button>
    </div>
</form>
