<!-- Company Form - Ultra Compact -->
<form 
    hx-post="{% if company %}{% url 'company:edit' company.pk %}{% else %}{% url 'company:create' %}{% endif %}"
    hx-encoding="multipart/form-data"
    x-data="{ loading: false }"
    @submit="loading = true"
    class="space-y-3">
    {% csrf_token %}
    
    <!-- Error Messages -->
    <div id="form-errors" class="hidden">
        <div class="bg-red-50 border border-red-200 text-red-800 px-3 py-2 rounded-lg text-xs">
            <i class="fas fa-exclamation-circle mr-1"></i>
            <span id="error-message"></span>
        </div>
    </div>
    
    <!-- Company Code -->
    <div>
        <label for="code" class="block text-xs font-medium text-gray-700 mb-1">
            Company Code <span class="text-red-500">*</span>
        </label>
        <input 
            type="text" 
            name="code" 
            id="code"
            value="{{ company.code|default:'' }}"
            required
            maxlength="20"
            placeholder="e.g., YGY"
            class="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            {% if company %}readonly{% endif %}>
        <p class="mt-0.5 text-xs text-gray-500">Unique identifier for the company (cannot be changed after creation)</p>
    </div>
    
    <!-- Company Name -->
    <div>
        <label for="name" class="block text-xs font-medium text-gray-700 mb-1">
            Company Name <span class="text-red-500">*</span>
        </label>
        <input 
            type="text" 
            name="name" 
            id="name"
            value="{{ company.name|default:'' }}"
            required
            maxlength="200"
            placeholder="e.g., Yogya Group"
            class="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
    </div>
    
    <!-- Logo Upload -->
    <div>
        <label for="logo" class="block text-xs font-medium text-gray-700 mb-1">
            Company Logo
        </label>
        {% if company.logo %}
        <div class="mb-2">
            <img src="{{ company.logo.url }}" 
                 alt="{{ company.name }}" 
                 class="w-16 h-16 rounded-lg object-cover border border-gray-200"
                 onerror="this.style.display='none'">
        </div>
        {% endif %}
        <input 
            type="file" 
            name="logo" 
            id="logo"
            accept="image/*"
            class="w-full px-3 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <p class="mt-0.5 text-xs text-gray-500">PNG, JPG or JPEG (max 2MB)</p>
    </div>
    
    <!-- Timezone -->
    <div>
        <label for="timezone" class="block text-xs font-medium text-gray-700 mb-1">
            Timezone
        </label>
        <select 
            name="timezone" 
            id="timezone"
            class="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="Asia/Jakarta" {% if not company or company.timezone == 'Asia/Jakarta' %}selected{% endif %}>Asia/Jakarta (WIB)</option>
            <option value="Asia/Makassar" {% if company.timezone == 'Asia/Makassar' %}selected{% endif %}>Asia/Makassar (WITA)</option>
            <option value="Asia/Jayapura" {% if company.timezone == 'Asia/Jayapura' %}selected{% endif %}>Asia/Jayapura (WIT)</option>
        </select>
    </div>
    
    <!-- Loyalty Program Settings -->
    <div class="border-t pt-3">
        <h4 class="text-xs font-semibold text-gray-900 mb-2">Loyalty Program Settings</h4>
        
        <div class="grid grid-cols-2 gap-3">
            <!-- Points per Currency -->
            <div>
                <label for="points_per_currency" class="block text-xs font-medium text-gray-700 mb-1">
                    Points / IDR
                </label>
                <input 
                    type="number" 
                    name="points_per_currency" 
                    id="points_per_currency"
                    value="{{ company.points_per_currency|default:'1.00' }}"
                    step="0.01"
                    min="0.01"
                    class="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <p class="mt-0.5 text-xs text-gray-500">e.g., 1.00 = 1 point per Rp 1</p>
            </div>
            
            <!-- Point Expiry -->
            <div>
                <label for="point_expiry_months" class="block text-xs font-medium text-gray-700 mb-1">
                    Expiry (months)
                </label>
                <input 
                    type="number" 
                    name="point_expiry_months" 
                    id="point_expiry_months"
                    value="{{ company.point_expiry_months|default:'12' }}"
                    min="0"
                    class="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <p class="mt-0.5 text-xs text-gray-500">0 = never expire</p>
            </div>
        </div>
    </div>
    
    <!-- Status -->
    <div class="flex items-center">
        <input 
            type="checkbox" 
            name="is_active" 
            id="is_active"
            {% if not company or company.is_active %}checked{% endif %}
            class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
        <label for="is_active" class="ml-2 text-xs font-medium text-gray-700">
            Active Company
        </label>
    </div>
    
    <!-- Form Actions -->
    <div class="flex justify-end gap-2 pt-3 border-t">
        <button 
            type="button"
            @click="showModal = false"
            class="px-4 py-1.5 bg-white text-gray-700 text-sm font-medium rounded-lg border border-gray-300 hover:bg-gray-50 transition">
            Cancel
        </button>
        <button 
            type="submit"
            :disabled="loading"
            class="px-4 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition disabled:opacity-50">
            <span x-show="!loading">
                <i class="fas fa-save mr-1"></i>
                {% if company %}Update{% else %}Create{% endif %}
            </span>
            <span x-show="loading">
                <i class="fas fa-spinner fa-spin mr-1"></i>
                Saving...
            </span>
        </button>
    </div>
</form>

<script>
    // Handle form submission response
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.target.id === 'modal-content') {
            try {
                const response = JSON.parse(evt.detail.xhr.response);
                if (response.success) {
                    window.location.href = response.redirect;
                } else {
                    // Show error
                    document.getElementById('form-errors').classList.remove('hidden');
                    document.getElementById('error-message').textContent = response.message;
                }
            } catch (e) {
                // Not a JSON response, might be form validation errors
            }
        }
    });
</script>
