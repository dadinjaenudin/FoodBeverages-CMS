<!-- Recipe Form -->
<form 
    hx-post="{% if recipe %}{% url 'recipe:edit' recipe.pk %}{% else %}{% url 'recipe:create' %}{% endif %}"
    hx-target="#modal-content"
    hx-swap="innerHTML"
    class="space-y-4"
    x-data="{ submitting: false }"
    @submit="submitting = true">
    {% csrf_token %}
    
    <!-- Error Container -->
    <div id="form-errors" class="hidden p-3 text-sm text-red-700 bg-red-100 border border-red-400 rounded" role="alert"></div>
    
    <!-- Brand (Read-only when editing) -->
    {% if recipe %}
        <div>
            <label class="block mb-1 text-sm font-medium text-gray-700">Brand</label>
            <div class="px-3 py-2 text-sm text-gray-700 bg-gray-50 border border-gray-300 rounded-lg">
                {{ recipe.brand.name }} ({{ recipe.brand.company.name }})
            </div>
            <input type="hidden" name="brand_id" value="{{ recipe.brand.id }}">
        </div>
    {% else %}
        <div>
            <label for="brand_id" class="block mb-1 text-sm font-medium text-gray-700">
                Brand <span class="text-red-500">*</span>
            </label>
            <select 
                id="brand_id" 
                name="brand_id" 
                required
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">-- Select Brand --</option>
                {% for brand in brands %}
                    <option value="{{ brand.id }}">{{ brand.name }} - {{ brand.company.name }}</option>
                {% endfor %}
            </select>
        </div>
    {% endif %}
    
    <!-- Product (Read-only when editing) -->
    {% if recipe %}
        <div>
            <label class="block mb-1 text-sm font-medium text-gray-700">Product</label>
            <div class="px-3 py-2 text-sm text-gray-700 bg-gray-50 border border-gray-300 rounded-lg">
                {{ recipe.product.name }} ({{ recipe.product.sku }})
            </div>
            <input type="hidden" name="product_id" value="{{ recipe.product.id }}">
        </div>
    {% else %}
        <div>
            <label for="product_id" class="block mb-1 text-sm font-medium text-gray-700">
                Product <span class="text-red-500">*</span>
            </label>
            <select 
                id="product_id" 
                name="product_id" 
                required
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">-- Select Product --</option>
                {% for product in products %}
                    <option value="{{ product.id }}">{{ product.name }} ({{ product.sku }})</option>
                {% endfor %}
            </select>
            <p class="mt-1 text-xs text-gray-500">The menu item this recipe is for</p>
        </div>
    {% endif %}
    
    <!-- Recipe Code & Version -->
    <div class="grid grid-cols-2 gap-4">
        <!-- Recipe Code -->
        <div>
            <label for="recipe_code" class="block mb-1 text-sm font-medium text-gray-700">
                Recipe Code <span class="text-red-500">*</span>
            </label>
            <input 
                type="text" 
                id="recipe_code" 
                name="recipe_code" 
                value="{{ recipe.recipe_code|default:'' }}"
                required
                maxlength="50"
                placeholder="e.g., RCP-001"
                class="w-full px-3 py-2 text-sm font-mono border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent uppercase">
        </div>
        
        <!-- Version (Read-only when editing) -->
        {% if recipe %}
            <div>
                <label class="block mb-1 text-sm font-medium text-gray-700">Version</label>
                <div class="px-3 py-2 text-sm text-gray-700 bg-gray-50 border border-gray-300 rounded-lg">
                    v{{ recipe.version }}
                </div>
                <input type="hidden" name="version" value="{{ recipe.version }}">
            </div>
        {% else %}
            <div>
                <label for="version" class="block mb-1 text-sm font-medium text-gray-700">
                    Version <span class="text-red-500">*</span>
                </label>
                <input 
                    type="number" 
                    id="version" 
                    name="version" 
                    value="1"
                    min="1"
                    required
                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <p class="mt-1 text-xs text-gray-500">Recipe versioning</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Recipe Name -->
    <div>
        <label for="recipe_name" class="block mb-1 text-sm font-medium text-gray-700">
            Recipe Name <span class="text-red-500">*</span>
        </label>
        <input 
            type="text" 
            id="recipe_name" 
            name="recipe_name" 
            value="{{ recipe.recipe_name|default:'' }}"
            required
            maxlength="200"
            placeholder="e.g., Grilled Chicken Recipe, Espresso Coffee"
            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
    </div>
    
    <!-- Yield & Preparation Type -->
    <div class="grid grid-cols-3 gap-4">
        <!-- Yield Quantity -->
        <div>
            <label for="yield_quantity" class="block mb-1 text-sm font-medium text-gray-700">
                Yield Qty <span class="text-red-500">*</span>
            </label>
            <input 
                type="number" 
                id="yield_quantity" 
                name="yield_quantity" 
                value="{{ recipe.yield_quantity|default:1 }}"
                min="0.01"
                step="0.01"
                required
                placeholder="1"
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        
        <!-- Yield Unit -->
        <div>
            <label for="yield_unit" class="block mb-1 text-sm font-medium text-gray-700">
                Unit <span class="text-red-500">*</span>
            </label>
            <input 
                type="text" 
                id="yield_unit" 
                name="yield_unit" 
                value="{{ recipe.yield_unit|default:'' }}"
                required
                maxlength="20"
                placeholder="portion, cup, plate"
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        
        <!-- Preparation Type -->
        <div>
            <label for="preparation_type" class="block mb-1 text-sm font-medium text-gray-700">
                Prep Type <span class="text-red-500">*</span>
            </label>
            <select 
                id="preparation_type" 
                name="preparation_type" 
                required
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">-- Select --</option>
                <option value="prep" {% if recipe.preparation_type == 'prep' %}selected{% endif %}>Preparation</option>
                <option value="cook" {% if recipe.preparation_type == 'cook' %}selected{% endif %}>Cooking</option>
                <option value="fry" {% if recipe.preparation_type == 'fry' %}selected{% endif %}>Frying</option>
                <option value="assemble" {% if recipe.preparation_type == 'assemble' %}selected{% endif %}>Assembly</option>
            </select>
        </div>
    </div>
    
    <!-- Effective Date -->
    <div>
        <label for="effective_date" class="block mb-1 text-sm font-medium text-gray-700">
            Effective Date <span class="text-red-500">*</span>
        </label>
        <input 
            type="date" 
            id="effective_date" 
            name="effective_date" 
            value="{{ recipe.effective_date|date:'Y-m-d'|default:'' }}"
            required
            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <p class="mt-1 text-xs text-gray-500">When this recipe becomes active</p>
    </div>
    
    <!-- Active Status -->
    <div class="flex items-center">
        <input 
            type="checkbox" 
            id="is_active" 
            name="is_active" 
            value="1"
            {% if not recipe or recipe.is_active %}checked{% endif %}
            class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
        <label for="is_active" class="ml-2 text-sm font-medium text-gray-700">
            Active (recipe is available for use)
        </label>
    </div>
    
    <!-- Note about ingredients -->
    {% if not recipe %}
    <div class="p-3 text-sm bg-blue-50 border border-blue-200 rounded-lg">
        <div class="flex items-start">
            <svg class="w-5 h-5 mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
            </svg>
            <div>
                <p class="font-medium text-blue-800">Recipe Ingredients</p>
                <p class="mt-1 text-xs text-blue-700">After creating the recipe, you can add ingredients (BOM) in the detailed recipe page.</p>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Form Actions -->
    <div class="flex justify-end gap-2 pt-4 border-t">
        <button 
            type="button"
            @click="$dispatch('close-modal')"
            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
            Cancel
        </button>
        <button 
            type="submit"
            :disabled="submitting"
            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
            <span x-show="!submitting">{% if recipe %}Update{% else %}Create{% endif %}</span>
            <span x-show="submitting" class="flex items-center">
                <svg class="w-4 h-4 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Saving...
            </span>
        </button>
    </div>
</form>

<script>
// Handle form submission response
document.getElementById('modal-content').addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.successful) {
        const response = JSON.parse(event.detail.xhr.response);
        if (response.success) {
            // Close modal
            document.dispatchEvent(new CustomEvent('close-modal'));
            // Trigger table refresh
            htmx.trigger('#recipe-table', 'refresh');
            // Show success message
            window.showToast(response.message, 'success');
        } else {
            // Show error in form
            const errorDiv = document.getElementById('form-errors');
            errorDiv.textContent = response.message;
            errorDiv.classList.remove('hidden');
        }
    }
});
</script>
